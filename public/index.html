<!DOCTYPE html>
<html lang="hi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>पार्थ - श्री कृष्ण सहायक</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+Devanagari:wght@300;400;500;600;700&display=swap');
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Noto Sans Devanagari', serif;
            background: linear-gradient(135deg, #1a1a3a 0%, #2d1b69 25%, #8b5a2b 50%, #ff7700 75%, #ffeb3b 100%);
            min-height: 100vh;
            color: #333;
            overflow-x: hidden;
            overflow-y: auto;
            position: relative;
        }

        body::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><circle cx="20" cy="20" r="2" fill="rgba(255,215,0,0.3)"><animate attributeName="opacity" values="0;1;0" dur="3s" repeatCount="indefinite"/></circle><circle cx="80" cy="30" r="1.5" fill="rgba(255,215,0,0.4)"><animate attributeName="opacity" values="0;1;0" dur="4s" repeatCount="indefinite"/></circle><circle cx="60" cy="80" r="2.5" fill="rgba(255,215,0,0.2)"><animate attributeName="opacity" values="0;1;0" dur="5s" repeatCount="indefinite"/></circle></svg>') repeat;
            animation: starfield 20s linear infinite;
            pointer-events: none;
        }

        @keyframes starfield {
            0% { transform: translateY(0); }
            100% { transform: translateY(-100px); }
        }

        .container {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            padding: 20px 8px;
            position: relative;
            z-index: 1;
        }

        .header {
            text-align: center;
            margin-bottom: 40px;
            animation: fadeInDown 1s ease-out;
        }

        .krishna-symbol {
            font-size: 4rem;
            margin-bottom: 20px;
            animation: glow 2s ease-in-out infinite alternate;
            text-shadow: 0 0 20px rgba(255, 215, 0, 0.8);
        }

        @keyframes glow {
            from { text-shadow: 0 0 20px rgba(255, 215, 0, 0.8), 0 0 30px rgba(255, 215, 0, 0.6); }
            to { text-shadow: 0 0 30px rgba(255, 215, 0, 1), 0 0 40px rgba(255, 215, 0, 0.8); }
        }

        .title {
            font-size: 3.5rem;
            color: #ffd700;
            margin-bottom: 10px;
            font-weight: 700;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);
            letter-spacing: 2px;
        }

        .subtitle {
            font-size: 1.4rem;
            color: rgba(255, 255, 255, 0.9);
            margin-bottom: 20px;
            font-weight: 400;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.3);
        }

        .main-interface {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(20px);
            border-radius: 30px;
            padding: 32px 12px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(255, 215, 0, 0.3);
            text-align: center;
            min-width: 0;
            width: 100%;
            max-width: 420px;
            animation: fadeInUp 1s ease-out 0.3s both;
        }

        .voice-button {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            background: radial-gradient(circle at 30% 30%, #ffd700, #ff8c00, #ff4500);
            border: none;
            cursor: pointer;
            position: relative;
            transition: all 0.3s ease;
            box-shadow: 0 10px 30px rgba(255, 140, 0, 0.4);
            margin: 20px 0;
        }

        .voice-button:hover {
            transform: scale(1.05);
            box-shadow: 0 15px 40px rgba(255, 140, 0, 0.6);
        }

        .voice-button.listening {
            animation: pulse 1.5s ease-in-out infinite;
            background: radial-gradient(circle at 30% 30%, #ff6b6b, #ee5a24, #c44569);
        }

        @keyframes pulse {
            0% { transform: scale(1); box-shadow: 0 10px 30px rgba(255, 140, 0, 0.4); }
            50% { transform: scale(1.1); box-shadow: 0 20px 50px rgba(255, 107, 107, 0.8); }
            100% { transform: scale(1); box-shadow: 0 10px 30px rgba(255, 140, 0, 0.4); }
        }

        .mic-icon {
            font-size: 2.2rem;
            color: white;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
        }

        .status-text {
            font-size: 1.1rem;
            color: rgba(255, 255, 255, 0.9);
            margin: 16px 0;
            font-weight: 500;
            min-height: 30px;
        }

        .response-area {
            min-height: 180px;
            max-height: 320px;
            overflow-y: auto;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 20px;
            padding: 14px;
            margin: 16px 0;
            border: 1px solid rgba(255, 215, 0, 0.2);
            text-align: left;
        }

        .krishna-message {
            background: linear-gradient(135deg, rgba(255, 215, 0, 0.1), rgba(255, 140, 0, 0.1));
            border-left: 4px solid #ffd700;
            padding: 14px;
            border-radius: 15px;
            margin-bottom: 12px;
            color: white;
            line-height: 1.7;
            font-size: 1rem;
            animation: slideInLeft 0.5s ease-out;
        }

        @keyframes slideInLeft {
            from { opacity: 0; transform: translateX(-30px); }
            to { opacity: 1; transform: translateX(0); }
        }

        .krishna-greeting {
            font-style: italic;
            color: #ffd700;
            margin-bottom: 10px;
        }

        .verse-section {
            background: rgba(255, 215, 0, 0.1);
            padding: 15px;
            border-radius: 10px;
            margin: 15px 0;
            border: 1px solid rgba(255, 215, 0, 0.3);
        }

        .sanskrit-text {
            font-family: 'Noto Sans Devanagari', serif;
            font-size: 1rem;
            color: #ffd700;
            font-style: italic;
            margin-bottom: 8px;
        }

        .controls {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin-top: 16px;
            flex-wrap: wrap;
        }

        .control-btn {
            padding: 10px 14px;
            border: none;
            border-radius: 25px;
            background: rgba(255, 255, 255, 0.1);
            color: white;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 1px solid rgba(255, 215, 0, 0.3);
            font-family: 'Noto Sans Devanagari', serif;
            font-weight: 500;
            font-size: 1rem;
        }

        .control-btn:hover {
            background: rgba(255, 215, 0, 0.2);
            transform: translateY(-2px);
        }

        .volume-control {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-top: 14px;
            color: rgba(255, 255, 255, 0.8);
        }

        .volume-slider {
            width: 100px;
            height: 5px;
            background: rgba(255, 255, 255, 0.3);
            border-radius: 5px;
            outline: none;
            cursor: pointer;
        }

        .loading-spinner {
            display: none;
            width: 40px;
            height: 40px;
            border: 4px solid rgba(255, 215, 0, 0.3);
            border-top: 4px solid #ffd700;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }

        .loading-spinner.show {
            display: block;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .connection-status {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 10px 15px;
            border-radius: 20px;
            font-size: 0.9rem;
            font-weight: 500;
            z-index: 1000;
        }

        .connected {
            background: rgba(76, 175, 80, 0.9);
            color: white;
        }

        .disconnected {
            background: rgba(244, 67, 54, 0.9);
            color: white;
        }

        .audio-visualizer {
            display: none;
            justify-content: center;
            align-items: center;
            gap: 3px;
            margin: 20px 0;
        }

        .audio-visualizer.show {
            display: flex;
        }

        .bar {
            width: 4px;
            height: 20px;
            background: #ffd700;
            border-radius: 2px;
            animation: visualizer 1s ease-in-out infinite;
        }

        .bar:nth-child(2) { animation-delay: 0.1s; }
        .bar:nth-child(3) { animation-delay: 0.2s; }
        .bar:nth-child(4) { animation-delay: 0.3s; }
        .bar:nth-child(5) { animation-delay: 0.4s; }

        @keyframes visualizer {
            0%, 100% { height: 20px; }
            50% { height: 60px; }
        }

        @keyframes fadeInDown {
            from { opacity: 0; transform: translateY(-30px); }
            to { opacity: 1; transform: translateY(0); }
        }

        @keyframes fadeInUp {
            from { opacity: 0; transform: translateY(30px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .om-symbol {
            position: absolute;
            font-size: 8rem;
            color: rgba(255, 215, 0, 0.1);
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 0;
            animation: rotate 30s linear infinite;
        }

        @keyframes rotate {
            from { transform: translate(-50%, -50%) rotate(0deg); }
            to { transform: translate(-50%, -50%) rotate(360deg); }
        }

        @media (max-width: 768px) {
            .main-interface {
                min-width: 0;
                width: 100%;
                max-width: 98vw;
                padding: 18px 4vw;
            }
            .title {
                font-size: 2rem;
            }
            .voice-button {
                width: 70px;
                height: 70px;
            }
            .mic-icon {
                font-size: 1.5rem;
            }
            .response-area {
                min-height: 100px;
                max-height: 180px;
                padding: 8px;
            }
            .krishna-message {
                font-size: 0.95rem;
                padding: 8px;
            }
            .control-btn {
                font-size: 0.95rem;
                padding: 8px 10px;
            }
            .volume-slider {
                width: 70px;
            }
        }

        @media (max-width: 480px) {
            .main-interface {
                padding: 10px 2vw;
                max-width: 100vw;
            }
            .title {
                font-size: 1.3rem;
            }
            .voice-button {
                width: 54px;
                height: 54px;
            }
            .mic-icon {
                font-size: 1.1rem;
            }
            .response-area {
                min-height: 60px;
                max-height: 120px;
                padding: 4px;
            }
            .krishna-message {
                font-size: 0.85rem;
                padding: 4px;
            }
            .control-btn {
                font-size: 0.85rem;
                padding: 6px 6px;
            }
            .volume-slider {
                width: 40px;
            }
        }

        /* Scrollbar styling */
        .response-area::-webkit-scrollbar {
            width: 6px;
        }

        .response-area::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 3px;
        }

        .response-area::-webkit-scrollbar-thumb {
            background: rgba(255, 215, 0, 0.5);
            border-radius: 3px;
        }
    </style>
</head>
<body>
    <div class="om-symbol">🕉</div>
    
    <div class="connection-status" id="connectionStatus">
        <span class="disconnected">कनेक्ट हो रहा है...</span>
    </div>

    <div class="container">
        <div class="header">
            <div class="krishna-symbol">🪶</div>
            <h1 class="title">पार्थ</h1>
            <p class="subtitle">अपने मन के प्रश्न • गीता के उत्तर</p>
        </div>

        <div class="main-interface">
            <div class="status-text" id="statusText">
                हे पार्थ! तुम्हारे संशयों को दूर करने मैं उपस्थित हूँ। अपना प्रश्न बोलो।"
            </div>

            <button id="voiceButton" class="voice-button" onclick="toggleVoiceRecording()">
                <div class="mic-icon">🎤</div>
            </button>

            <div class="audio-visualizer" id="audioVisualizer">
                <div class="bar"></div>
                <div class="bar"></div>
                <div class="bar"></div>
                <div class="bar"></div>
                <div class="bar"></div>
            </div>

            <div class="loading-spinner" id="loadingSpinner"></div>

            <div class="response-area" id="responseArea">
                <div class="krishna-message">
                    <div class="krishna-greeting">॥ श्री कृष्ण कहते हैं ॥</div>
                    प्रिय पार्थ, मैं यहां आपके हर प्रश्न का उत्तर देने के लिए हूं। जीवन की कोई भी चुनौती हो, धर्म की कोई भी उलझन हो, या मन में कोई भी दुविधा हो - निःसंकोच पूछें। गीता का ज्ञान सदैव आपके साथ है।
                    <div class="verse-section">
                        <div class="sanskrit-text">सर्वधर्मान्परित्यज्य मामेकं शरणं व्रज</div>
                        सभी धर्मों को छोड़कर मेरी शरण में आओ
                    </div>
                </div>
            </div>

            <div class="volume-control">
                <span>🔊</span>
                <input type="range" id="volumeSlider" class="volume-slider" 
                       min="0" max="1" step="0.1" value="0.8" onchange="setVolume(this.value)">
                <span>आवाज़</span>
            </div>

            <div class="controls">
                <button class="control-btn" onclick="clearConversation()">
                    🗑️ साफ़ करें
                </button>
                <button class="control-btn" onclick="getRandomVerse()">
                    📿 श्लोक सुनें
                </button>
                <button class="control-btn" onclick="stopSpeaking()" id="stopBtn" style="display: none;">
                    ⏹️ रोकें
                </button>
            </div>
        </div>
    </div>

    <script>
        class PaarthKrishnaAssistant {
            constructor() {
                this.ws = null;
                this.isRecording = false;
                this.mediaRecorder = null;
                this.audioChunks = [];
                this.currentTTS = null;
                this.volume = 0.8;
                this.isConnected = false;
                this.isProcessing = false;
                
                this.initializeWebSocket();
                this.initializeSpeechSynthesis();
            }

            initializeWebSocket() {
                try {
                    const protocol = window.location.protocol === "https:" ? "wss:" : "ws:";
                    this.ws = new WebSocket(`${protocol}//${window.location.host}`);


                    this.ws.onopen = () => {
                        this.isConnected = true;
                        this.updateConnectionStatus(true);
                        this.updateStatus('🟢 कृष्ण से जुड़ाव सफल! अब बोलें...');
                        this.speakKrishnaMessage('प्रणाम पार्थ! मैं कृष्ण हूं। आपकी सेवा में उपस्थित हूं।');
                    };

                    this.ws.onmessage = (event) => {
                        this.handleWebSocketMessage(JSON.parse(event.data));
                    };

                    this.ws.onclose = () => {
                        this.isConnected = false;
                        this.updateConnectionStatus(false);
                        this.updateStatus('❌ कनेक्शन टूट गया। पेज रीफ्रेश करें।');
                    };

                    this.ws.onerror = (error) => {
                        console.error('WebSocket error:', error);
                        this.updateStatus('❌ कनेक्शन में समस्या है।');
                    };

                } catch (error) {
                    console.error('WebSocket initialization failed:', error);
                    this.updateStatus('❌ सर्वर से जुड़ नहीं पा रहे।');
                }
            }

            handleWebSocketMessage(data) {
                this.hideLoading();

                switch (data.type) {
                    case 'connection_established':
                        this.addKrishnaResponse('🙏 प्रणाम! मैं कृष्ण हूं। आपकी हर समस्या का समाधान गीता में है।');
                        break;

                    case 'text_response':
                        this.addKrishnaResponse(data.text);
                        this.speakKrishnaMessage(data.text);
                        this.updateStatus('🎤 अगला प्रश्न बोलें...');
                        break;

                    case 'random_verse':
                        this.displayVerse(data.verse);
                        break;

                    case 'error':
                        this.updateStatus(`❌ ${data.message}`);
                        break;
                }
            }

            async startRecording() {
                if (!this.isConnected || this.isProcessing) return;

                try {
                    const stream = await navigator.mediaDevices.getUserMedia({ 
                        audio: {
                            echoCancellation: true,
                            noiseSuppression: true,
                            sampleRate: 44100,
                            channelCount: 1
                        } 
                    });

                    this.mediaRecorder = new MediaRecorder(stream, {
                        mimeType: 'audio/webm;codecs=opus'
                    });

                    this.audioChunks = [];
                    this.isRecording = true;
                    
                    this.updateVoiceButton(true);
                    this.showAudioVisualizer(true);
                    this.updateStatus('🎙️ सुन रहा हूं... बोलें');

                    this.mediaRecorder.ondataavailable = (event) => {
                        if (event.data.size > 0) {
                            this.audioChunks.push(event.data);
                        }
                    };

                    this.mediaRecorder.onstop = () => {
                        const audioBlob = new Blob(this.audioChunks, { type: 'audio/webm' });
                        this.sendAudioToKrishna(audioBlob);
                        
                        // Stop all tracks
                        stream.getTracks().forEach(track => track.stop());
                        
                        this.showAudioVisualizer(false);
                        this.updateVoiceButton(false);
                        this.updateStatus('🤔 कृष्ण सोच रहे हैं...');
                    };

                    this.mediaRecorder.start();

                    // Auto-stop after 30 seconds
                    setTimeout(() => {
                        if (this.isRecording) {
                            this.stopRecording();
                        }
                    }, 30000);

                } catch (error) {
                    console.error('Error starting recording:', error);
                    this.updateStatus('❌ माइक्रोफोन की अनुमति चाहिए।');
                }
            }

            stopRecording() {
                if (this.mediaRecorder && this.isRecording) {
                    this.mediaRecorder.stop();
                    this.isRecording = false;
                }
            }

            async sendAudioToKrishna(audioBlob) {
                try {
                    this.isProcessing = true;
                    this.showLoading();
                    
                    const reader = new FileReader();
                    reader.onloadend = () => {
                        const base64Audio = reader.result.split(',')[1];
                        
                        if (this.ws && this.ws.readyState === WebSocket.OPEN) {
                            this.ws.send(JSON.stringify({
                                type: 'audio_data',
                                audio: base64Audio,
                                context: 'krishna_conversation'
                            }));
                        }
                    };
                    reader.readAsDataURL(audioBlob);

                } catch (error) {
                    console.error('Error sending audio:', error);
                    this.hideLoading();
                    this.isProcessing = false;
                    this.updateStatus('❌ ऑडियो भेजने में समस्या।');
                }
            }

            speakKrishnaMessage(text) {
                try {
                    this.stopSpeaking();

                    if (!window.speechSynthesis) {
                        console.warn('Text-to-Speech not supported');
                        return;
                    }

                    // Clean the text for better TTS
                    let cleanText = text
                        .replace(/[🙏🪶📿🕉️🎤🔊]/g, '') // Remove emojis
                        .replace(/॥.*॥/g, '') // Remove Sanskrit markers
                        .replace(/\*.*\*/g, '') // Remove emphasized text
                        .trim();

                    this.currentTTS = new SpeechSynthesisUtterance(cleanText);
                    this.currentTTS.lang = 'hi-IN';
                    this.currentTTS.volume = this.volume;
                    this.currentTTS.rate = 0.85; // Slower, more thoughtful pace
                    this.currentTTS.pitch = 0.9; // Slightly lower pitch for wisdom

                    // Try to find best Hindi voice
                    const voices = speechSynthesis.getVoices();
                    const hindiVoice = voices.find(voice => 
                        voice.lang === 'hi-IN' || 
                        voice.lang.startsWith('hi') ||
                        voice.name.toLowerCase().includes('hindi')
                    );
                    
                    if (hindiVoice) {
                        this.currentTTS.voice = hindiVoice;
                    }

                    this.currentTTS.onstart = () => {
                        document.getElementById('stopBtn').style.display = 'inline-block';
                        this.updateStatus('🗣️ कृष्ण बोल रहे हैं...');
                    };

                    this.currentTTS.onend = () => {
                        document.getElementById('stopBtn').style.display = 'none';
                        this.updateStatus('🎤 अगला प्रश्न बोलें...');
                        this.currentTTS = null;
                        this.isProcessing = false;
                    };

                    this.currentTTS.onerror = (error) => {
                        console.error('TTS Error:', error);
                        document.getElementById('stopBtn').style.display = 'none';
                        this.isProcessing = false;
                    };

                    speechSynthesis.speak(this.currentTTS);

                } catch (error) {
                    console.error('Error in Text-to-Speech:', error);
                    this.isProcessing = false;
                }
            }

            stopSpeaking() {
                if (speechSynthesis.speaking) {
                    speechSynthesis.cancel();
                }
                if (this.currentTTS) {
                    this.currentTTS = null;
                }
                document.getElementById('stopBtn').style.display = 'none';
            }

            addKrishnaResponse(text) {
                const responseArea = document.getElementById('responseArea');
                
                const messageDiv = document.createElement('div');
                messageDiv.className = 'krishna-message';
                
                // Format the message with Krishna's style
                const formattedText = this.formatKrishnaResponse(text);
                messageDiv.innerHTML = formattedText;
                
                responseArea.appendChild(messageDiv);
                responseArea.scrollTop = responseArea.scrollHeight;
            }

            formatKrishnaResponse(text) {
                let formatted = text;
                
                // Add Krishna greeting if not present
                if (!text.includes('॥') && !text.includes('कृष्ण')) {
                    formatted = '<div class="krishna-greeting">॥ श्री कृष्ण कहते हैं ॥</div>' + formatted;
                }

                // Format Sanskrit verses
                formatted = formatted.replace(
                    /([\u0900-\u097F\s]+॥|॥[\u0900-\u097F\s]+)/g,
                    '<div class="verse-section"><div class="sanskrit-text">$1</div></div>'
                );

                // Format references to Gita chapters/verses
                formatted = formatted.replace(
                    /(अध्याय \d+[,\s]*श्लोक \d+)/g,
                    '<strong style="color: #ffd700;">$1</strong>'
                );

                return formatted;
            }

            displayVerse(verse) {
                const verseHtml = `
                    <div class="krishna-greeting">॥ आज का श्लोक ॥</div>
                    <div class="verse-section">
                        <strong style="color: #ffd700;">अध्याय ${verse.chapter}, श्लोक ${verse.verse}</strong><br><br>
                        <div class="sanskrit-text">${verse.sanskrit}</div><br>
                        <strong>अर्थ:</strong> ${verse.hindi}<br><br>
                        <strong>व्याख्या:</strong> ${verse.meaning}
                    </div>
                `;
                
                this.addKrishnaResponse(verseHtml);
                
                // Speak the verse with proper pronunciation
                const spokenText = `अध्याय ${verse.chapter}, श्लोक ${verse.verse}. ${verse.hindi}. ${verse.meaning}`;
                this.speakKrishnaMessage(spokenText);
            }

            updateConnectionStatus(connected) {
                const statusEl = document.getElementById('connectionStatus');
                const span = statusEl.querySelector('span');
                
                if (connected) {
                    span.textContent = '🟢 कृष्ण से जुड़े';
                    span.className = 'connected';
                } else {
                    span.textContent = '🔴 कनेक्शन नहीं';
                    span.className = 'disconnected';
                }
            }

            updateVoiceButton(recording) {
                const button = document.getElementById('voiceButton');
                const icon = button.querySelector('.mic-icon');
                
                if (recording) {
                    button.classList.add('listening');
                    icon.textContent = '⏸️';
                } else {
                    button.classList.remove('listening');
                    icon.textContent = '🎤';
                }
            }

            showAudioVisualizer(show) {
                const visualizer = document.getElementById('audioVisualizer');
                if (show) {
                    visualizer.classList.add('show');
                } else {
                    visualizer.classList.remove('show');
                }
            }

            updateStatus(text) {
                document.getElementById('statusText').textContent = text;
            }

            showLoading() {
                document.getElementById('loadingSpinner').classList.add('show');
            }

            hideLoading() {
                document.getElementById('loadingSpinner').classList.remove('show');
            }

            initializeSpeechSynthesis() {
                // Load voices when available
                if (speechSynthesis.onvoiceschanged !== undefined) {
                    speechSynthesis.onvoiceschanged = () => {
                        const voices = speechSynthesis.getVoices();
                        console.log('Available voices for Krishna:', voices.filter(v => v.lang.startsWith('hi')));
                    };
                }
                
                // Initial greeting
                setTimeout(() => {
                    if (this.isConnected) {
                        this.speakKrishnaMessage('नमस्कार पार्थ! मैं कृष्ण हूं। आपका स्वागत है।');
                    }
                }, 2000);
            }

            setVolume(volume) {
                this.volume = parseFloat(volume);
                if (this.currentTTS) {
                    this.currentTTS.volume = this.volume;
                }
            }

            getRandomVerse() {
                if (this.ws && this.ws.readyState === WebSocket.OPEN) {
                    this.ws.send(JSON.stringify({ type: 'get_random_verse' }));
                }
            }

            clearConversation() {
                document.getElementById('responseArea').innerHTML = `
                    <div class="krishna-message">
                        <div class="krishna-greeting">॥ श्री कृष्ण कहते हैं ॥</div>
                        प्रिय पार्थ, मैं यहां आपके हर प्रश्न का उत्तर देने के लिए हूं। जीवन की कोई भी चुनौती हो, धर्म की कोई भी उलझन हो, या मन में कोई भी दुविधा हो - निःसंकोच पूछें। गीता का ज्ञान सदैव आपके साथ है।
                        <div class="verse-section">
                            <div class="sanskrit-text">सर्वधर्मान्परित्यज्य मामेकं शरणं व्रज</div>
                            सभी धर्मों को छोड़कर मेरी शरण में आओ
                        </div>
                    </div>
                `;
                this.updateStatus('🎤 नया प्रश्न बोलें...');
            }
        }

        // Global instance
        let krishnaAssistant;

        // Global functions
        function toggleVoiceRecording() {
            if (krishnaAssistant.isRecording) {
                krishnaAssistant.stopRecording();
            } else {
                krishnaAssistant.startRecording();
            }
        }

        function setVolume(volume) {
            krishnaAssistant.setVolume(volume);
        }

        function stopSpeaking() {
            krishnaAssistant.stopSpeaking();
        }

        function getRandomVerse() {
            krishnaAssistant.getRandomVerse();
        }

        function clearConversation() {
            krishnaAssistant.clearConversation();
        }

        // Initialize when page loads
        window.addEventListener('DOMContentLoaded', () => {
            krishnaAssistant = new PaarthKrishnaAssistant();
        });

        // Handle page visibility changes
        document.addEventListener('visibilitychange', () => {
            if (document.hidden && krishnaAssistant?.isRecording) {
                krishnaAssistant.stopRecording();
            }
        });

        // Handle before unload
        window.addEventListener('beforeunload', () => {
            if (krishnaAssistant?.isRecording) {
                krishnaAssistant.stopRecording();
            }
            krishnaAssistant?.stopSpeaking();
        });

        // Keyboard shortcuts
        document.addEventListener('keydown', (e) => {
            if (e.code === 'Space' && !e.repeat) {
                e.preventDefault();
                toggleVoiceRecording();
            }
            if (e.key === 'Escape') {
                stopSpeaking();
            }
        });

        document.addEventListener('keyup', (e) => {
            if (e.code === 'Space') {
                e.preventDefault();
                if (krishnaAssistant?.isRecording) {
                    krishnaAssistant.stopRecording();
                }
            }
        });
    </script>
</body>
</html>
